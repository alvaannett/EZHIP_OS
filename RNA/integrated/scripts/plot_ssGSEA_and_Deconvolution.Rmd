---
title: "ssGSEA and Deconvolution"
output:
  html_document:
    df_print: paged
    theme: flatly
    number_sections: yes
    toc: yes
    toc_float: yes
    code_folding: hide
params:
  out_path: "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/figures/ssGSEA/"
---

/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Muscle_Tissue_hg/out/02_gene_sets/skeletal_muscle_atlas_gene_sets.n100.Rda

```{r}
library(tidyverse)
library(scales)
library(ComplexHeatmap)
library(ggrepel)
library(BayesPrism)
```

```{r}
dir.create(params$out_path)
```

```{r}
plot_geneset = function(id, group_pal = c('WT' = 'blue', 'EZHIP' = 'red')){

id_plot = str_replace_all(id, ' ', '_')
id_plot = str_replace_all(id_plot, '[.]', '_')
id_plot = str_replace_all(id_plot, '[/]', '_')

p = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group')
)  %>%
  select(ID, sample, Group, ssGSEA, Deconvolution) %>%
  filter(ID == id) %>%
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution')),
         Group = factor(Group, levels = names(group_pal))) %>% 
ggplot(aes(Group, value, color = Group)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 18),
        panel.grid = element_blank(),
        legend.title = element_blank(),  
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2,
        plot.title = element_text(hjust = 0.5)) +
  facet_wrap(.~name, scales = 'free_y') +
  ggtitle(id) +
  stat_summary(fun = "mean", geom = "crossbar", colour = "black", width = 0.2) +
  stat_compare_means(label = "p.signif")

p %>% print 

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.', id_plot, '.dotplot.pdf'), height = 4, width = 7)
p %>% print 
dev.off()

genes = (deg %>% 
  filter(ENS %in% unlist(atlas[['hg_ens']][id])) %>%
  filter(padj < 0.05 & log2FoldChange > 0 & baseMean > 0) %>%
  slice_max(order_by = log2FoldChange, n=10))$ENS

p = counts %>% 
  filter(ENS %in% genes) %>%
  select(-ENS) %>%
  pivot_longer(-SYM) %>%
  left_join(meta, by = c('name' = 'Nickname')) %>%
  mutate(Group = factor(Group, levels = names(group_pal))) %>%
  ggplot(aes(Group, value, color = Group)) +
  geom_point(size = 2, alpha = 0.8) +
  facet_wrap(.~SYM, scales = 'free_y') +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 10),
        panel.grid = element_blank(),
        legend.title = element_blank(),  
        axis.title.x = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
          aspect.ratio = 0.9) +
	scale_y_continuous(labels = label_number(suffix = "K", scale = 1e-3)) +
  ylab('Norm Counts') 

p %>% print 

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.', id_plot, '.genes_dotplot.pdf'))
p %>% print 
dev.off()

mat = counts %>% 
  filter(ENS %in% genes) %>%
  select(-ENS) %>%
  column_to_rownames('SYM') %>%
  t() 

mat = t(scale(mat))

col_fun = circlize::colorRamp2(c(range(mat)[1], 0, range(mat)[2]), c("#235789", "#F2EFC7", "#BC412B")) 

mat = mat[,meta$Nickname, drop=F]

ha = columnAnnotation(cond = meta$Group, col = list(cond = group_pal))

h = Heatmap(mat,
        name = 'RNA', 
        bottom_annotation = ha, 
        row_title = str_replace(params$atlas_prefix, '_', ' '),
        col = col_fun, 
        width = ncol(mat)*unit(4, "mm"),
        height = nrow(mat)*unit(4, "mm"),
        rect_gp = gpar(color = 'black'), 
        show_row_dend = F)

draw(h, heatmap_legend_side = "left", annotation_legend_side = 'left')

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.', id_plot, '.heatmap.pdf'), height = 10)
draw(h, heatmap_legend_side = "left", annotation_legend_side = 'left')
dev.off()
}
```

```{r}
sort_genesets = function(ssgsea, theta){
stat.1 = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP - WT) / WT) %>%
  mutate(n = dense_rank(FC)) 

stat.2 = theta %>% 
  as.data.frame() %>% 
  rownames_to_column('ID') %>%
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP - WT) / WT) %>%
  filter(EZHIP > 1 | WT > 1) %>%
  mutate(n = dense_rank(FC)) 

order = (stat.1 %>% arrange(n))$ID

p1 = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  filter(ID %in% order) %>%
  mutate(ID = factor(ID, levels = order)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

order = (stat.2 %>% arrange(n))$ID

p2 = theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  filter(ID %in% order) %>%
  mutate(ID = factor(ID, levels = order)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

return(list(p1, p2))
}
```

```{r}
sort_genesets_U2OS = function(ssgsea, theta){
stat.1 = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP - EZHIP_KO) / EZHIP_KO) %>%
  mutate(n = dense_rank(FC)) 

stat.2 = theta %>% 
  as.data.frame() %>% 
  rownames_to_column('ID') %>%
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP - EZHIP_KO) / EZHIP_KO) %>%
  filter(EZHIP > 1 | EZHIP_KO > 1) %>%
  mutate(n = dense_rank(FC)) 

order = (stat.1 %>% arrange(n))$ID

p1 = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  filter(ID %in% order) %>%
  mutate(ID = factor(ID, levels = order)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

order = (stat.2 %>% arrange(n))$ID

p2 = theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  filter(ID %in% order) %>%
  mutate(ID = factor(ID, levels = order)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

return(list(p1, p2))
}
```

# hMSC 

```{r}
sample_prefix = 'hMSC'
raptor_path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/hMSC/out/01_raptor_exprtools/EZHIP/"
```

```{r}
group_pal = c('blue', 'red')
names(group_pal) = data.table::fread(paste0(raptor_path, "info.groups.tsv"))$Group
meta = data.table::fread(paste0(raptor_path, "info.samples.tsv" )) 

counts = data.table::fread(paste0(raptor_path, "/counts/Ensembl.ensGene.exon.norm.tsv.gz")) %>%
  separate(V1, sep = ':', into = c('ENS', 'SYM'))

deg = data.table::fread(paste0(raptor_path, "/diff/Ensembl.ensGene.exon/WTvsEZHIP.tsv"))%>%
  separate(ID, sep = ':', into = c('ENS', 'SYM'))
```

## Baccin 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/hMSC/out/04_ssGSEA/baccin_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/hMSC/out/03_deconvolution/Skeletal_Development_Baccin_mm/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
p1 = sort_genesets(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'), width = 5)
p1
dev.off()
```

```{r}
id = "Smooth muscle"
plot_geneset(id)

id = "Adipo-CAR"
plot_geneset(id)

id = "Chondrocytes"
plot_geneset(id)

id = "Osteoblasts"
plot_geneset(id)

id = "Myofibroblasts"
plot_geneset(id)
```

## DeMicheli 

```{r}
atlas_prefix = 'demicheli'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Muscle_Tissue_hg/out/02_gene_sets/skeletal_muscle_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/hMSC/out/04_ssGSEA/demicheli_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/hMSC/out/03_deconvolution/Skeletal_Muscle_Tissue_hg/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```


```{r}
p1 = sort_genesets(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "ACTA2+ MYH11+ MYL9+ Smooth muscle cells"
plot_geneset(id)
```

```{r}
id = "APOD+ CFD+ PLAC9+ Adipocytes"
plot_geneset(id)
```



# MG63 Cell Line 

```{r}
sample_prefix = 'MG63_cell'
raptor_path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/MG63/out/01_raptor_exprtools/EZHIP/"
```

```{r}
group_pal = c('blue', 'red')
names(group_pal) = data.table::fread(paste0(raptor_path, "info.groups.tsv"))$Group
meta = data.table::fread(paste0(raptor_path, "info.samples.tsv" )) 

counts = data.table::fread(paste0(raptor_path, "/counts/Ensembl.ensGene.exon.norm.tsv.gz")) %>%
  separate(V1, sep = ':', into = c('ENS', 'SYM'))

deg = data.table::fread(paste0(raptor_path, "/diff/Ensembl.ensGene.exon/WTvsEZHIP.tsv"))%>%
  separate(ID, sep = ':', into = c('ENS', 'SYM'))
```

## Baccin 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/MG63/out/04_ssGSEA/baccin_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/MG63/out/03_deconvolution/Skeletal_Development_Baccin_mm/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```


```{r}
p1 = sort_genesets(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```



```{r}
id = "Osteo-CAR"
plot_geneset(id)
```

```{r}
id = "Adipo-CAR"
plot_geneset(id)
```

# KHOS Cell Line  

```{r}
sample_prefix = 'KHOS_cell'
raptor_path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/KHOS/out/01_raptor_exprtools/EZHIP/"
```

```{r}
group_pal = c('blue', 'red')
names(group_pal) = data.table::fread(paste0(raptor_path, "info.groups.tsv"))$Group
meta = data.table::fread(paste0(raptor_path, "info.samples.tsv" )) 

counts = data.table::fread(paste0(raptor_path, "/counts/Ensembl.ensGene.exon.norm.tsv.gz")) %>%
  separate(V1, sep = ':', into = c('ENS', 'SYM'))

deg = data.table::fread(paste0(raptor_path, "/diff/Ensembl.ensGene.exon/WTvsEZHIP.tsv"))%>%
  separate(ID, sep = ':', into = c('ENS', 'SYM'))
```

## Baccin 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/KHOS/out/04_ssGSEA/baccin_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/KHOS/out/03_deconvolution/Skeletal_Development_Baccin_mm/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
tmp = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname'))

# calculate p-value 
stat = as.data.frame(t((rbind(by(tmp, tmp$ID, function(ssGSEA) { t.test(ssGSEA~Group, data=ssGSEA, paired=FALSE)$p.value })))))

names(stat) = 'p_val'

# adjust p-value 
stat = stat %>% 
  rownames_to_column('ID') %>%
  mutate(adj_p_val = p.adjust(p_val, method = 'fdr')) %>%
  arrange(adj_p_val)

# add log2 FC 
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]] - .data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC) %>%
  full_join(stat, by = 'ID')

stat
```

```{r}
order = (stat %>% arrange(FC))$ID

p1 = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group')
)  %>%
  mutate(ID = factor(ID, levels = order)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "Osteo-CAR"
plot_geneset(id)
```

```{r}
id = "Adipo-CAR"
plot_geneset(id)
```

## Baryawno 

```{r}
atlas_prefix = 'baryawno'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Development_Baryawno_mm/out/01_gene_sets/develop_bone_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/KHOS/out/04_ssGSEA/baryawno_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/KHOS/out/03_deconvolution/Skeletal_Development_Baryawno_mm/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
tmp = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname'))

# calculate p-value 
stat = as.data.frame(t((rbind(by(tmp, tmp$ID, function(ssGSEA) { t.test(ssGSEA~Group, data=ssGSEA, paired=FALSE)$p.value })))))

names(stat) = 'p_val'

# adjust p-value 
stat = stat %>% 
  rownames_to_column('ID') %>%
  mutate(adj_p_val = p.adjust(p_val, method = 'fdr')) %>%
  arrange(adj_p_val)

# add log2 FC 
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]] - .data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC) %>%
  full_join(stat, by = 'ID')

stat
```

```{r}
order = (stat %>% arrange(FC))$ID

p1 = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group')
)  %>%
  mutate(ID = factor(ID, levels = order)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "Early_Osteoprogenitors"
plot_geneset(id)
```

## DeMicheli 

```{r}
atlas_prefix = 'demicheli'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Muscle_Tissue_hg/out/02_gene_sets/skeletal_muscle_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/KHOS/out/04_ssGSEA/demicheli_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/KHOS/out/03_deconvolution/Skeletal_Muscle_Tissue_hg/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```
```{r}
tmp = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname'))

# calculate p-value 
stat = as.data.frame(t((rbind(by(tmp, tmp$ID, function(ssGSEA) { t.test(ssGSEA~Group, data=ssGSEA, paired=FALSE)$p.value })))))

names(stat) = 'p_val'

# adjust p-value 
stat = stat %>% 
  rownames_to_column('ID') %>%
  mutate(adj_p_val = p.adjust(p_val, method = 'fdr')) %>%
  arrange(adj_p_val)

# add log2 FC 
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]] - .data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC) %>%
  full_join(stat, by = 'ID')

stat
```

```{r}
order = (stat %>% arrange(FC))$ID

p1 = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group')
)  %>%
  mutate(ID = factor(ID, levels = order)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "PAX7+ DLK1+ MuSCs and progenitors"
plot_geneset(id)
```




# U2OS 

```{r}
sample_prefix = 'U2OS'
raptor_path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/U2OS/out/01_raptor_exprtools/EZHIP_minus_C77_C2/"
```

```{r}
group_pal = c('blue', 'red')
names(group_pal) = data.table::fread(paste0(raptor_path, "info.groups.tsv"))$Group
meta = data.table::fread(paste0(raptor_path, "info.samples.tsv" )) 

counts = data.table::fread(paste0(raptor_path, "/counts/Ensembl.ensGene.exon.norm.tsv.gz")) %>%
  separate(V1, sep = ':', into = c('ENS', 'SYM'))

deg = data.table::fread(paste0(raptor_path, "/diff/Ensembl.ensGene.exon/EZHIP_KOvsEZHIP.tsv"))%>%
  separate(ID, sep = ':', into = c('ENS', 'SYM'))
```

## Baccin 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/U2OS/out/04_ssGSEA/baccin_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/U2OS/out/03_deconvolution/Skeletal_Development_Baccin_mm/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```



```{r}
p1 = sort_genesets_U2OS(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "Smooth muscle"
plot_geneset(id, group_pal = c('EZHIP_KO' = 'blue', 'EZHIP' = 'red'))
```

```{r}
id = "Osteo-CAR"
plot_geneset(id, group_pal = c('EZHIP_KO' = 'blue', 'EZHIP' = 'red'))
```

```{r}
id = "Adipo-CAR"
plot_geneset(id, group_pal = c('EZHIP_KO' = 'blue', 'EZHIP' = 'red'))
```

```{r}
id = "Ng2+ MSCs"
plot_geneset(id, group_pal = c('EZHIP_KO' = 'blue', 'EZHIP' = 'red'))
```

## Baryawno 

```{r}
atlas_prefix = 'baryawno'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Development_Baryawno_mm/out/01_gene_sets/develop_bone_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/U2OS/out/04_ssGSEA/baryawno_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/U2OS/out/03_deconvolution/Skeletal_Development_Baryawno_mm/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```



```{r}
p1 = sort_genesets_U2OS(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "OLC_1"
plot_geneset(id,  group_pal = c('EZHIP_KO' = 'blue', 'EZHIP' = 'red'))
```

## DeMicheli 

```{r}
atlas_prefix = 'demicheli'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Muscle_Tissue_hg/out/02_gene_sets/skeletal_muscle_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/U2OS/out/04_ssGSEA/demicheli_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/U2OS/out/03_deconvolution/Skeletal_Muscle_Tissue_hg/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```
```{r}
tmp = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname'))

# calculate p-value 
stat = as.data.frame(t((rbind(by(tmp, tmp$ID, function(ssGSEA) { t.test(ssGSEA~Group, data=ssGSEA, paired=FALSE)$p.value })))))

names(stat) = 'p_val'

# adjust p-value 
stat = stat %>% 
  rownames_to_column('ID') %>%
  mutate(adj_p_val = p.adjust(p_val, method = 'fdr')) %>%
  arrange(adj_p_val)

# add log2 FC 
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]] - .data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC) %>%
  full_join(stat, by = 'ID')

stat
```
```{r}
p1 = sort_genesets_U2OS(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "PAX7low MYF5+ MuSCs and progenitors"
plot_geneset(id,  group_pal = c('EZHIP_KO' = 'blue', 'EZHIP' = 'red'))
```

```{r}
id = 'ACTA1+ Mature skeletal muscle'
plot_geneset(id,  group_pal = c('EZHIP_KO' = 'blue', 'EZHIP' = 'red'))
```


# MG63 Xenograft

```{r}
sample_prefix = 'MG63_Xgraft'
raptor_path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/01_raptor_exprtools/MG63/"
```

```{r}
group_pal = c('blue', 'red')
names(group_pal) = data.table::fread(paste0(raptor_path, "info.groups.tsv"))$Group
meta = data.table::fread(paste0(raptor_path, "info.samples.tsv" )) 

counts = data.table::fread(paste0(raptor_path, "/counts/hg19.Ensembl.ensGene.exon.norm.tsv.gz")) %>%
  separate(V1, sep = ':', into = c('ENS', 'SYM'))

deg = data.table::fread(paste0(raptor_path, "/diff/hg19.Ensembl.ensGene.exon/WTvsEZHIP.tsv"))%>%
  separate(ID, sep = ':', into = c('ENS', 'SYM'))
```

## Baccin 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/04_ssGSEA/MG63/baccin_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/05_deconvolution/Skeletal_Development_Baccin_mm/MG63/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```



```{r}
p1 = sort_genesets(ssgsea, theta )
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```
```{r}
id = "Adipo-CAR"
plot_geneset(id)
```

```{r}
id = "Osteo-CAR"
plot_geneset(id)
```
```{r}
id = "Osteoblasts"
plot_geneset(id)
```
```{r}
id = "Fibro/Chondro p."
plot_geneset(id)
```

## Baryawno 

```{r}
atlas_prefix = 'baryawno'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Development_Baryawno_mm/out/01_gene_sets/develop_bone_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/04_ssGSEA/MG63/baryawno_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/05_deconvolution/Skeletal_Development_Baryawno_mm/MG63/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```


```{r}
p1 = sort_genesets(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```
```{r}
id = "Early_Osteoprogenitors"
plot_geneset(id)
```

```{r}
id = "Osteoprogenitors"
plot_geneset(id)
```

```{r}
id = "Mature_osteoblasts"
plot_geneset(id)
```

```{r}
id = "Osteochondro_cells"
plot_geneset(id)
```

## DeMicheli 

```{r}
atlas_prefix = 'demicheli'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Muscle_Tissue_hg/out/02_gene_sets/skeletal_muscle_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/04_ssGSEA/MG63/demicheli_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/05_deconvolution/Skeletal_Muscle_Tissue_hg/MG63/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```


```{r}
p1 = sort_genesets(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "PAX7+ DLK1+ MuSCs and progenitors"
plot_geneset(id)
```





# KHOS Xenograft

```{r}
sample_prefix = 'KHOS_Xgraft'
raptor_path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/01_raptor_exprtools/KHOS/"
```

```{r}
group_pal = c('blue', 'red')
names(group_pal) = data.table::fread(paste0(raptor_path, "info.groups.tsv"))$Group
meta = data.table::fread(paste0(raptor_path, "info.samples.tsv" )) 

counts = data.table::fread(paste0(raptor_path, "/counts/hg19.Ensembl.ensGene.exon.norm.tsv.gz")) %>%
  separate(V1, sep = ':', into = c('ENS', 'SYM'))

deg = data.table::fread(paste0(raptor_path, "/diff/hg19.Ensembl.ensGene.exon/WTvsEZHIP.tsv"))%>%
  separate(ID, sep = ':', into = c('ENS', 'SYM'))
```

## Baccin 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/04_ssGSEA/KHOS/baccin_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/05_deconvolution/Skeletal_Development_Baccin_mm/KHOS/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
p1 = sort_genesets(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```
```{r}
id = "Fibro/Chondro p."
plot_geneset(id)
```

```{r}
id = "Osteoblasts"
plot_geneset(id)
```

```{r}
id = "Adipo-CAR"
plot_geneset(id)
```

## Baryawno 

```{r}
atlas_prefix = 'baryawno'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Development_Baryawno_mm/out/01_gene_sets/develop_bone_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/04_ssGSEA/KHOS/baryawno_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/05_deconvolution/Skeletal_Development_Baryawno_mm/KHOS/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
tmp = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname'))

# calculate p-value 
stat_ssgsea = as.data.frame(t((rbind(by(tmp, tmp$ID, function(ssGSEA) { t.test(ssGSEA~Group, data=ssGSEA, paired=FALSE)$p.value })))))

names(stat_ssgsea) = 'p_val'

# adjust p-value 
stat_ssgsea = stat_ssgsea %>% 
  rownames_to_column('ID') %>%
  mutate(adj_p_val = p.adjust(p_val, method = 'fdr')) %>%
  arrange(adj_p_val)

# add log2 FC 
stat_ssgsea = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]]) - (.data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC) %>%
  full_join(stat_ssgsea, by = 'ID')

stat_ssgsea
```


```{r}
p1 = sort_genesets(ssgsea, theta)
p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```
```{r}
id = "Early_Osteoprogenitors"
plot_geneset(id)
```

```{r}
id = "Chondro_progen"
plot_geneset(id)
```

```{r}
id = "Osteoprogenitors"
plot_geneset(id)
```
```{r}
id = "Early_Osteoprogenitors"
plot_geneset(id)
```

## DeMicheli 

```{r}
atlas_prefix = 'demicheli'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Muscle_Tissue_hg/out/02_gene_sets/skeletal_muscle_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/04_ssGSEA/KHOS/demicheli_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/xgrafts/out/05_deconvolution/Skeletal_Muscle_Tissue_hg/KHOS/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
tmp = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname'))

# calculate p-value 
stat = as.data.frame(t((rbind(by(tmp, tmp$ID, function(ssGSEA) { t.test(ssGSEA~Group, data=ssGSEA, paired=FALSE)$p.value })))))

names(stat) = 'p_val'

# adjust p-value 
stat = stat %>% 
  rownames_to_column('ID') %>%
  mutate(adj_p_val = p.adjust(p_val, method = 'fdr')) %>%
  arrange(adj_p_val)

# add log2 FC 
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]]) - (.data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC) %>%
  full_join(stat, by = 'ID')

stat
```

```{r}
order = (stat %>% arrange(FC))$ID

p1 = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group')
)  %>%
  mutate(ID = factor(ID, levels = order)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "ACTA2+ MYH11+ MYL9+ Smooth muscle cells"
plot_geneset(id)
```





# MG63 Xenograft and Culture and U2OS 

```{r}
sample_prefix = 'U2OS_MG63'
raptor_path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/cell_lines/out/01_raptor_exprtools/EZHIP_U2OS_MG63_KHOS_xeno_cell/"
```

```{r}
group_pal = c('blue', 'red')
names(group_pal) = data.table::fread(paste0(raptor_path, "info.groups.tsv"))$Group
meta = data.table::fread(paste0(raptor_path, "info.samples.tsv" )) 

counts = data.table::fread(paste0(raptor_path, "/counts/Ensembl.ensGene.exon.norm.tsv.gz")) %>%
  separate(V1, sep = ':', into = c('ENS', 'SYM'))

deg = data.table::fread(paste0(raptor_path, "/diff/Ensembl.ensGene.exon/WTvsEZHIP.tsv"))%>%
  separate(ID, sep = ':', into = c('ENS', 'SYM'))
```

## Baccin 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/cell_lines/out/04_ssGSEA/baccin_n100.ssgsea.txt'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group, Cell_Line) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group, Cell_Line) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP - WT) / WT) %>%
  mutate(n = dense_rank(FC)) %>%
  arrange(desc(FC)) %>%
  filter(Cell_Line %in% c('U2OS', 'MG63 Culture', 'MG63 Xenograft')) %>%
  pivot_wider(-c(n, WT, EZHIP), names_from = Cell_Line, values_from = FC) %>%
  mutate(r.U2OS = dense_rank(dplyr::desc(U2OS)),
         r.MG.cell = dense_rank(dplyr::desc(`MG63 Culture`)), 
         r.MG.xeno = dense_rank(dplyr::desc(`MG63 Xenograft`))) %>%
  mutate(lab = ifelse(r.MG.xeno < 10 & r.MG.cell < 10, ID, NA))
  

p1 = stat %>% 
  ggplot(aes(x = `MG63 Xenograft`, y = `MG63 Culture`, size = U2OS, label = lab)) +
    geom_point() +
    geom_text_repel(size = 4,  box.padding = 0.5) +
   theme_bw() +
  theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 1,
        plot.title = element_text(hjust = 0.5)) +
  geom_hline(yintercept = 0, size = 0.5, color = 'red', linetype = 'dotted') +
  geom_vline(xintercept = 0, size = 0.5, color = 'red', linetype = 'dotted')

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.foldchnage.pdf'), width = 5, height = 5)
p1
dev.off()
```

```{r}
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group, Cell_Line) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group, Cell_Line) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP - WT) / WT) %>%
  mutate(n = dense_rank(FC)) %>%
  arrange(desc(FC)) %>%
  filter(Cell_Line %in% c('U2OS', 'KHOS Culture', 'KHOS Xenograft')) %>%
  pivot_wider(-c(n, WT, EZHIP), names_from = Cell_Line, values_from = FC) %>%
  mutate(r.U2OS = dense_rank(dplyr::desc(U2OS)),
         r.MG.cell = dense_rank(dplyr::desc(`KHOS Culture`)), 
         r.MG.xeno = dense_rank(dplyr::desc(`KHOS Xenograft`))) %>%
  mutate(lab = ifelse(r.MG.xeno < 10 & r.MG.cell < 10, ID, NA))
  

p1 = stat %>% 
  ggplot(aes(x = `KHOS Xenograft`, y = `KHOS Culture`, label = lab)) +
    geom_point() +
    geom_text_repel(size = 4,  box.padding = 0.5) +
   theme_bw() +
  theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 1,
        plot.title = element_text(hjust = 0.5)) +
  geom_hline(yintercept = 0, size = 0.5, color = 'red', linetype = 'dotted') +
  geom_vline(xintercept = 0, size = 0.5, color = 'red', linetype = 'dotted')

pdf(paste0(params$out_path, 'KHOS_cell_xeno', '.', atlas_prefix, '.foldchnage.pdf'), width = 5, height = 5)
p1
dev.off()
```


## Barywano 

```{r}
atlas_prefix = 'baryawno'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Development_Baryawno_mm/out/01_gene_sets/develop_bone_atlas_gene_sets.n100.Rda'

ssgsea_path1 = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/cell_lines/out/04_ssGSEA/baryawno_n100.ssgsea.txt'
ssgsea_path2 = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/cell_lines/out/04_ssGSEA/baccin_n100.ssgsea.txt'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```


```{r}
ssgsea1 = data.table::fread(ssgsea_path1)
ssgsea2 = data.table::fread(ssgsea_path2)
colnames(ssgsea1) == colnames(ssgsea2)

ssgsea = rbind(ssgsea1, ssgsea2)
```


```{r}
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group, Cell_Line) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group, Cell_Line) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP - WT) / WT) %>%
  mutate(n = dense_rank(FC)) %>%
  arrange(desc(FC)) %>%
  filter(Cell_Line %in% c('U2OS', 'MG63 Culture', 'MG63 Xenograft')) %>%
  pivot_wider(-c(n, WT, EZHIP), names_from = Cell_Line, values_from = FC) %>%
  mutate(r.U2OS = dense_rank(dplyr::desc(U2OS)),
         r.MG.cell = dense_rank(dplyr::desc(`MG63 Culture`)), 
         r.MG.xeno = dense_rank(dplyr::desc(`MG63 Xenograft`))) %>%
  mutate(lab = ifelse(r.MG.xeno < 10 & r.MG.cell < 10, ID, NA),
         lab = ifelse(r.MG.xeno > 55 & r.MG.cell > 55, ID, lab))
  

p1 = stat %>% 
  ggplot(aes(x = `MG63 Xenograft`, y = `U2OS`, size = U2OS, label = lab)) +
    geom_point() +
    geom_text_repel(size = 4,  box.padding = 0.5) +
   theme_bw() +
  theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 1,
        plot.title = element_text(hjust = 0.5)) +
  geom_hline(yintercept = 0, size = 0.5, color = 'red', linetype = 'dotted') +
  geom_vline(xintercept = 0, size = 0.5, color = 'red', linetype = 'dotted')

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.foldchnage.pdf'), width = 5, height = 5)
p1
dev.off()
```

```{r}
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group, Cell_Line) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group, Cell_Line) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP - WT) / WT) %>%
  mutate(n = dense_rank(FC)) %>%
  arrange(desc(FC)) %>%
  filter(Cell_Line %in% c('U2OS', 'KHOS Culture', 'KHOS Xenograft')) %>%
  pivot_wider(-c(n, WT, EZHIP), names_from = Cell_Line, values_from = FC) %>%
  mutate(r.U2OS = dense_rank(dplyr::desc(U2OS)),
         r.MG.cell = dense_rank(dplyr::desc(`KHOS Culture`)), 
         r.MG.xeno = dense_rank(dplyr::desc(`KHOS Xenograft`))) %>%
  mutate(lab = ifelse(r.MG.xeno < 10 & r.MG.cell < 10, ID, NA))
  

p1 = stat %>% 
  ggplot(aes(x = `KHOS Xenograft`, y = `KHOS Culture`, label = lab)) +
    geom_point() +
    geom_text_repel(size = 4,  box.padding = 0.5) +
   theme_bw() +
  theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 1,
        plot.title = element_text(hjust = 0.5)) +
  geom_hline(yintercept = 0, size = 0.5, color = 'red', linetype = 'dotted') +
  geom_vline(xintercept = 0, size = 0.5, color = 'red', linetype = 'dotted')

pdf(paste0(params$out_path, 'KHOS_cell_xeno', '.', atlas_prefix, '.foldchnage.pdf'), width = 5, height = 5)
p1
dev.off()
```

# Clinical EZHIP pos vs EZHIP neg  

```{r}
sample_prefix = 'clinical'
raptor_path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/01_raptor_exprtools/EZHIP_neg_VsEZHIP_pos_no_reps/"
```

```{r}
group_pal = data.table::fread(paste0(raptor_path, "info.groups.tsv" ))$Color
names(group_pal) = data.table::fread(paste0(raptor_path, "info.groups.tsv" ))$Group

samples = c('PS_18_007707', 'TCMG171_OS_T', 'PRO00035_OS_RE1', 'SISJ0577_OS_T', 'TCMG238_OS_RE1', 'S12003')

meta = data.table::fread(paste0(raptor_path, "info.samples.tsv" )) %>%
  filter(Nickname %in% samples) %>%
  mutate(Group2 = Group, 
         Group = ifelse(Group == 'EZHIP_neg-K27me3_Low', 'EZHIP_neg', Group))

meta

counts = data.table::fread(paste0(raptor_path, "/counts/Ensembl.ensGene.exon.norm.tsv.gz")) %>%
  separate(V1, sep = ':', into = c('ENS', 'SYM'))

deg = data.table::fread(paste0(raptor_path, "/diff/Ensembl.ensGene.exon/EZHIP_negvsEZHIP_pos.tsv"))%>%
  separate(ID, sep = ':', into = c('ENS', 'SYM'))

deg %>% filter(padj < 0.05) %>% arrange(desc(log2FoldChange))
```

```{r}
genes = c('CXorf67')
p = counts %>% 
  filter(SYM %in% genes) %>%
  select(-ENS) %>%
  pivot_longer(-SYM) %>%
  left_join(meta, by = c('name' = 'Nickname')) %>%
  filter(name %in% samples) %>%
  mutate(Group = factor(Group, levels = c("EZHIP_neg", "EZHIP_pos"), labels = c('EZHIP-', 'EZHIP+'))) %>%
  ggplot(aes(Group, value, color = Group)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_color_manual(values = c('lightgrey', 'red')) +
  theme_bw() +
  theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.title.x = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2) +
	scale_y_continuous(labels = label_number(suffix = "K", scale = 1e-3)) +
  ylab('Norm Counts') +
  ggtitle('EZHIP')
p


pdf(paste0(params$out_path, sample_prefix, '.primary.EZHIPexp.pdf'), width = 5, height = 3)
p
dev.off()
```

## Cell Line Signs 

```{r}
atlas_prefix = 'cell_line_genesets.n100'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/cell_lines/out/gene_sets/cell_line_genesets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/04_ssGSEA/cell_line_genesets.n100.ssgsea.txt'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea = ssgsea %>% select(c(ID, meta$Nickname))
ssgsea
```

```{r}
# add log2 FC 
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  inner_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (EZHIP_pos - EZHIP_neg)/(EZHIP_neg)) %>%
  arrange(desc(FC)) 

stat
```

#### Primary

```{r}
samples = meta$Nickname

p1 = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  filter(sample %in% samples) %>%
  filter(ID %in% c('U2OS_cell', 'KHOS_Xeno', 'MG63_Xeno', 'MG63_cell', 'KHOS_cell')) %>%
  select(ID, sample, Group2, ssGSEA) %>%
  mutate(ID = factor(ID, 
                     labels = rev(c('U2OS cell culture', 'MG63 Xenograft', 'MG63 cell culture', 'KHOS Xenograft', 'KHOS cell culture')), 
                     levels = rev(c('U2OS_cell', 'MG63_Xeno', 'MG63_cell', 'KHOS_Xeno', 'KHOS_cell')))) %>%
  pivot_longer(-c(ID, sample, Group2)) %>%
ggplot(aes(ID, value, color = Group2)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = c('lightgrey', '#E6C229', 'red')) +
  theme_bw() +
  theme(text = element_text(size = 10),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title.y = element_blank(), 
        legend.position = 'right', 
        strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2,
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  coord_flip() +
  ylab('ssGSEA') 

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.primary.pdf'), width = 5, height = 3)
p1
dev.off()
```


```{r}
genes = (unlist(atlas[['hg_ens']]['U2OS_cell']))

tmp.1 = counts %>% 
  pivot_longer(-c(ENS, SYM), names_to = 'sample', values_to = 'NormCounts') %>%
  filter(sample %in% samples) %>%
  group_by(sample) %>% 
  arrange(desc(NormCounts)) %>%
  mutate(rank = rank(NormCounts, ties.method = "first")) 
  
tmp.2 = tmp.1 %>%
  filter(sample == 'S12003')

tmp.3 = tmp.1 %>%
  filter(sample == 'TCMG171_OS_T')

genes = (tmp.2 %>%
  filter(ENS %in% genes) %>%
  slice_max(order_by = NormCounts, n = 10))$ENS 
  

order = (tmp.1 %>% 
        filter(ENS %in% genes) %>%
         mutate(Group = ifelse(sample == 'S12003', 'S12003', 'rest')) %>%
         group_by(SYM, Group) %>%
         mutate(mean = mean(NormCounts)) %>%
         ungroup() %>%
         select(Group, mean, SYM) %>%
         distinct() %>%
         pivot_wider(names_from = Group, values_from = mean) %>%
         mutate(FC = (S12003-rest)/rest) %>%
         arrange(desc(FC)))$SYM

p1 = tmp.1 %>%
  filter(SYM %in% order) %>%
  mutate(SYM = factor(SYM, levels = rev(order))) %>%
  ggplot(aes(SYM, log2(NormCounts))) +
  geom_point(alpha = 0.8, color = 'lightgrey', size = 3) +
  geom_point(data = tmp.2 %>% filter(SYM %in% order), aes(SYM, log2(NormCounts)), size = 3, color = 'red') +
  theme_bw() +
  theme(text = element_text(size = 10),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title.y = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2,
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  coord_flip() +
  ggtitle('U2OS Culture - EZHIP KO vs EZHIP')


p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.U2OS_genes.primary.pdf'), height = 3)
p1
dev.off()
```

```{r}
genes = (unlist(atlas[['hg_ens']]['KHOS_Xeno']))

tmp.1 = counts %>% 
  pivot_longer(-c(ENS, SYM), names_to = 'sample', values_to = 'NormCounts') %>%
  filter(sample %in% samples) %>%
  group_by(sample) %>% 
  arrange(desc(NormCounts)) %>%
  mutate(rank = rank(NormCounts, ties.method = "first")) 
  
tmp.2 = tmp.1 %>%
  filter(sample == 'S12003')

genes = (tmp.2 %>%
  filter(ENS %in% genes) %>%
  slice_max(order_by = NormCounts, n = 10))$ENS 

order = (tmp.1 %>% 
        filter(ENS %in% genes) %>%
         mutate(Group = ifelse(sample == 'S12003', 'S12003', 'rest')) %>%
         group_by(SYM, Group) %>%
         mutate(mean = mean(NormCounts)) %>%
         ungroup() %>%
         select(Group, mean, SYM) %>%
         distinct() %>%
         pivot_wider(names_from = Group, values_from = mean) %>%
         mutate(FC = (S12003-rest)/rest) %>%
         arrange(desc(FC)))$SYM

p1 = tmp.1 %>%
  filter(SYM %in% order) %>%
  mutate(SYM = factor(SYM, levels = rev(order))) %>%
  ggplot(aes(SYM, log2(NormCounts))) +
  geom_point(alpha = 0.8, color = 'lightgrey', size = 3) +
  geom_point(data = tmp.2 %>% filter(SYM %in% order), aes(SYM, log2(NormCounts)), size = 3, color = 'red') +
  theme_bw() +
  theme(text = element_text(size = 10),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title.y = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2,
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  coord_flip() +
  ggtitle('KHOS Xenograft - WT vs EZHIP')

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.KHOS_genes.primary.pdf'), height = 3)
p1
dev.off()
```


```{r}
genes = (unlist(atlas[['hg_ens']]['MG63_Xeno']))

tmp.1 = counts %>% 
  pivot_longer(-c(ENS, SYM), names_to = 'sample', values_to = 'NormCounts') %>%
  filter(sample %in% samples) %>%
  group_by(sample) %>% 
  arrange(desc(NormCounts)) %>%
  mutate(rank = rank(NormCounts, ties.method = "first")) 
  
tmp.2 = tmp.1 %>%
  filter(sample == 'S12003')

genes = (tmp.2 %>%
  filter(ENS %in% genes) %>%
  slice_max(order_by = NormCounts, n = 10))$ENS 

order = (tmp.1 %>% 
        filter(ENS %in% genes) %>%
         mutate(Group = ifelse(sample == 'S12003', 'S12003', 'rest')) %>%
         group_by(SYM, Group) %>%
         mutate(mean = mean(NormCounts)) %>%
         ungroup() %>%
         select(Group, mean, SYM) %>%
         distinct() %>%
         pivot_wider(names_from = Group, values_from = mean) %>%
         mutate(FC = (S12003-rest)/rest) %>%
         arrange(desc(FC)))$SYM

p1 = tmp.1 %>%
  filter(SYM %in% order) %>%
  mutate(SYM = factor(SYM, levels = rev(order))) %>%
  ggplot(aes(SYM, log2(NormCounts))) +
  geom_point(alpha = 0.8, color = 'lightgrey', size = 3) +
  geom_point(data = tmp.2 %>% filter(SYM %in% order), aes(SYM, log2(NormCounts)), size = 3, color = 'red') +
  theme_bw() +
  theme(text = element_text(size = 10),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title.y = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2,
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  coord_flip() +
  ggtitle('MG63 Xenograft - WT vs EZHIP')


p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.MG63_genes.primary.pdf'), height = 3)
p1
dev.off()
```

## Baccin 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/04_ssGSEA/baccin_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/05_deconvolution/Skeletal_Development_Baccin_mm/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea = ssgsea %>% select(c(ID, meta$Nickname))
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() %>% select(c(meta$Nickname))
theta
```

```{r fig.width=10}
p1 = theta %>% 
  as.data.frame() %>% 
  rownames_to_column('ID') %>%
  pivot_longer(-ID, names_to = 'sample', values_to = '%') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  filter(sample %in% samples) %>%
  select(ID, sample, Group2, `%`) %>%
  pivot_longer(-c(ID, sample, Group2)) %>%
ggplot(aes(ID, value, color = Group2, label = sample)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = c('lightgrey', '#E6C229',  'red')) +
  theme_bw() +
  theme(text = element_text(size = 10),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title.y = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 1.5,
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  coord_flip() +
  ylab('%') 

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.primary.pdf'), width = 5, height = 3)
p1
dev.off()
```

```{r fig.width=10}
p1 = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  filter(sample %in% samples) %>%
  select(ID, sample, Group2, ssGSEA) %>%
  pivot_longer(-c(ID, sample, Group2)) %>%
ggplot(aes(ID, value, color = Group2, label = sample)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = c('lightgrey', '#E6C229', 'red')) +
  theme_bw() +
  theme(text = element_text(size = 10),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title.y = element_blank(), 
        legend.position = 'left', 
        strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 1.5,
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  coord_flip() +
  ylab('ssGSEA') 

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.primary.pdf'), width = 5, height = 3)
p1
dev.off()
```


```{r}
id = 'Ng2+ MSCs'
id_plot = str_replace_all(id, ' ', '_')
id_plot = str_replace_all(id_plot, '[.]', '_')
id_plot = str_replace_all(id_plot, '[/]', '_')

p = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group', 'Group2')
)  %>%
  select(ID, sample, Group, Group2, ssGSEA, Deconvolution) %>%
  filter(ID == id & sample %in% samples) %>%
  pivot_longer(-c(ID, sample, Group, Group2)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution')),
         Group = factor(Group, levels = names(group_pal)[1:2], labels = c('EZHIP-', 'EZHIP+'))) %>% 
ggplot(aes(Group, value, color = Group2)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_color_manual(values = c('lightgrey','#E6C229', 'red')) +
  theme_bw() +
  theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        legend.title = element_blank(),  
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2,
        plot.title = element_text(hjust = 0.5)) +
  facet_wrap(.~name, scales = 'free_y') +
  ggtitle(id)

p

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.', id_plot, '.dotplot.pdf'), height = 4, width = 7)
p 
dev.off()
```

```{r}
id = 'Osteoblasts'
id_plot = str_replace_all(id, ' ', '_')
id_plot = str_replace_all(id_plot, '[.]', '_')
id_plot = str_replace_all(id_plot, '[/]', '_')

p = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group', 'Group2')
)  %>%
  select(ID, sample, Group, Group2, ssGSEA, Deconvolution) %>%
  filter(ID == id & sample %in% samples) %>%
  pivot_longer(-c(ID, sample, Group, Group2)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution')),
         Group = factor(Group, levels = names(group_pal)[1:2], labels = c('EZHIP-', 'EZHIP+'))) %>% 
ggplot(aes(Group, value, color = Group2)) +
  geom_point(size = 5, alpha = 0.8) +
  scale_color_manual(values = c('lightgrey', '#E6C229', 'red')) +
  theme_bw() +
  theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        legend.title = element_blank(),  
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2,
        plot.title = element_text(hjust = 0.5)) +
  facet_wrap(.~name, scales = 'free_y') +
  ggtitle(id)

p

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.', id_plot, '.dotplot.pdf'), height = 4, width = 7)
p 
dev.off()
```

```{r}
genes = (unlist(atlas[['hg_ens']]['Ng2+ MSCs']))

tmp.1 = counts %>% 
  pivot_longer(-c(ENS, SYM), names_to = 'sample', values_to = 'NormCounts') %>%
  filter(sample %in% samples) %>%
  group_by(sample) %>% 
  arrange(desc(NormCounts)) %>%
  mutate(rank = rank(NormCounts, ties.method = "first")) 
  
tmp.2 = tmp.1 %>%
  filter(sample == 'S12003')

genes = (tmp.2 %>%
  filter(ENS %in% genes) %>%
  slice_max(order_by = NormCounts, n = 15))$ENS 
  

order = (tmp.1 %>% 
        filter(ENS %in% genes) %>%
         mutate(Group = ifelse(sample == 'S12003', 'S12003', 'rest')) %>%
         group_by(SYM, Group) %>%
         mutate(mean = mean(NormCounts)) %>%
         ungroup() %>%
         select(Group, mean, SYM) %>%
         distinct() %>%
         pivot_wider(names_from = Group, values_from = mean) %>%
         mutate(FC = (S12003-rest)/rest) %>%
         arrange(desc(FC)))$SYM

p1 = tmp.1 %>%
  filter(SYM %in% order) %>%
  mutate(SYM = factor(SYM, levels = rev(order))) %>%
  ggplot(aes(SYM, log2(NormCounts))) +
  geom_point(alpha = 0.8, color = 'lightgrey', size = 3) +
  geom_point(data = tmp.2 %>% filter(SYM %in% order), aes(SYM, log2(NormCounts)), size = 3, color = 'red') +
  theme_bw() +
 theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title.y = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 2,
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  coord_flip() +
  ggtitle('')

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.Ng2MSC.primary.pdf'), height = 4)
p1
dev.off()
```

## Baryawno 

```{r}
atlas_prefix = 'baryawno'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Development_Baryawno_mm/out/01_gene_sets/develop_bone_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/04_ssGSEA/baryawno_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/05_deconvolution/Skeletal_Development_Baryawno_mm/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
# add log2 FC 
stat_ssgsea = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]]) - (.data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC) 

stat_ssgsea
```

```{r}

# add log2 FC 
stat_deconv = theta %>%
  as.data.frame() %>% 
   rownames_to_column('ID') %>%
  pivot_longer(-ID, names_to = 'sample', values_to = 'frac') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(frac)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]]) - (.data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC)

stat_deconv
```
```{r}
order = (stat_ssgsea %>% arrange(FC))$ID

p1 = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group')
)  %>%
  select(ID, sample, Group, ssGSEA, Deconvolution) %>%
mutate(ID = factor(ID, levels = order),
         Group = ifelse(sample == 'S12003', 'S12003', Group)) %>%
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = group_pal) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "Preosteoblasts"
plot_geneset_clin(id)
```

```{r}
id = "Osteoprogenitors"
plot_geneset_clin(id)
```



## DeMicheli 

```{r}
atlas_prefix = 'demicheli'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Skeletal_Muscle_Tissue_hg/out/02_gene_sets/skeletal_muscle_atlas_gene_sets.n100.Rda'

ssgsea = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/04_ssGSEA/demicheli_n100.ssgsea.txt'
deconv = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/05_deconvolution/Skeletal_Muscle_Tissue_hg/bp.res.Rda'
```

```{r}
loadRData <- function(fileName){
#loads an RData file, and returns it
    load(fileName)
    get(ls()[ls() != "fileName"])
}
atlas = loadRData(atlas_path)
```

```{r}
load(deconv)
```

```{r}
ssgsea = data.table::fread(ssgsea)
ssgsea
```

```{r}
theta = get.fraction(bp=bp.res,
            which.theta="final",
            state.or.type="type") * 100

theta = theta %>% t %>% as.data.frame() 
theta
```

```{r}
# add log2 FC 
stat = ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')) %>%
  group_by(ID, Group) %>%
  mutate(mean = mean(ssGSEA)) %>%
  ungroup() %>%
  distinct(ID, mean, Group) %>%
  pivot_wider(names_from = Group, values_from = mean) %>%
  mutate(FC = (.data[[names(group_pal)[2]]]) - (.data[[names(group_pal)[1]]])/(.data[[names(group_pal)[1]]])) %>%
  arrange(desc(FC)) %>%
  select(ID, FC) 
stat
```

```{r}
order = (stat %>% arrange(FC))$ID

p1 = full_join(
ssgsea %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'ssGSEA') %>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
theta %>%
  rownames_to_column('ID') %>% 
  as.data.frame() %>% 
  pivot_longer(-ID, names_to = 'sample', values_to = 'Deconvolution')%>%
  left_join(meta %>% select(-ID), by = c('sample' = 'Nickname')),
by = c('sample', 'ID', 'Group')
)  %>%
  select(ID, sample, Group, ssGSEA, Deconvolution) %>%
  mutate(ID = factor(ID, levels = order),
         Group = ifelse(sample == 'S12003', 'S12003', Group)) %>% 
  pivot_longer(-c(ID, sample, Group)) %>%
  mutate(name = factor(name, levels = c('ssGSEA', 'Deconvolution'))) %>% 
ggplot(aes(ID, value, color = Group)) +
  geom_point(size = 4, alpha = 0.8) +
  scale_color_manual(values = c(group_pal, 'S12003' = 'gold')) +
  theme_bw() +
  theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title = element_blank(), 
        legend.position = 'none', 
        strip.background = element_blank(), 
        panel.grid.major.y = element_line(color = "lightgrey",
                                          size = 0.3,
                                          linetype = 2)) +
  facet_wrap(.~name, scales = 'free_x') +
  coord_flip()

p1

pdf(paste0(params$out_path, sample_prefix, '.', atlas_prefix, '.pdf'))
p1
dev.off()
```

```{r}
id = "PAX7+ DLK1+ MuSCs and progenitors"
plot_geneset_clin(id) 
```




# Joint clustering

## Baccin 

```{r}
pattern = 'baccin_n100.ssgsea.txt'
```

```{r}
group_pal = c('WT' = 'blue', 'EZHIP' = 'red')
```

### hMSC 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = 'baccin_n100.ssgsea.txt', 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('all', 'hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('hMSC_cell'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        legend.position = 'none',
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 0.9) + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

pdf(paste0(params$out_path, 'hMSC_cell_', atlas_prefix, '.PCA.pdf'), width = 6, height = 5)
pca_plot
dev.off()
```

### Cancer Cell Lines 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = 'baccin_n100.ssgsea.txt', 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'MG63_cell', 'U2OS_cell'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:4){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

### Cancer Cell Lines + hMSC 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = 'baccin_n100.ssgsea.txt', 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'MG63_cell', 'U2OS_cell', 'hMSC_cell'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

### Cancer Cell Lines + Xgrafts 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = 'baccin_n100.ssgsea.txt', 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'MG63_cell', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

### KHOS MG63 Cell Lines + Xgrafts 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = 'baccin_n100.ssgsea.txt', 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'MG63_cell', 'KHOS_xeno', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```


### MG63 Cell Lines + Xgrafts 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('MG63_cell', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```



### KHOS Cell Lines + Xgrafts 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'KHOS_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```




### U2OS + Xgrafts 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = 'baccin_n100.ssgsea.txt', 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:1){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        legend.position = 'none',
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 0.9) + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

pdf(paste0(params$out_path, 'U2OS-cell_KHOS-MG63-xeno', atlas_prefix, '.PCA.pdf'), width = 6, height = 5)
pca_plot
dev.off()

```


### Xgrafts 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = 'baccin_n100.ssgsea.txt', 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_xeno', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```





### Clinical 

```{r}
group_pal = c('EZHIP_neg' = 'blue', 'EZHIP_pos' = 'red')
```

```{r}
clical_meta = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/01_raptor_exprtools/EZHIP_neg_VsEZHIP_pos_no_reps/info.samples.tsv'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('clinical'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.table::fread(clical_meta) %>% 
  mutate(Sample = paste0('clinical.', Nickname)) 

pal = c('EZHIP_pos' = 'red', 'EZHIP_neg' = 'blue', 'H3K27me3_Low' = 'deepskyblue')
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Nickname)) +
  scale_color_manual(values = pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black", size = 2) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```
```{r}
meta = meta %>% filter(Nickname %in% samples)
df = df[,meta$Sample]
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Nickname)) +
  scale_color_manual(values = pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black", size = 2) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}
```

## Baryawno 

```{r}
pattern = 'baryawno_n100.ssgsea.txt'
```

```{r}
group_pal = c('WT' = 'blue', 'EZHIP' = 'red')
```

### Cancer Cell Lines 

```{r}
atlas_prefix = 'baccin'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'MG63_cell', 'U2OS_cell'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 p = pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        legend.position = 'none',
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),
        aspect.ratio = 0.9) + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}


p
```

### Cancer Cell Lines + hMSC 

```{r}
ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'MG63_cell', 'U2OS_cell', 'hMSC_cell'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

### Cancer Cell Lines + Xgrafts 

```{r}
ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'MG63_cell', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

### KHOS MG63 Cell Lines + Xgrafts 

```{r}
ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'MG63_cell', 'KHOS_xeno', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```


### MG63 Cell Lines + Xgrafts 

```{r}

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('MG63_cell', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```



### KHOS Cell Lines + Xgrafts 

```{r}
atlas_prefix = 'baccin'
atlas_path = '/lustre06/project/6004736/alvann/from_narval/REFERENCES/Bone_Marrow_Baccin/out/01_cluster_markers/bone_atlas_baccin_gene_sets.n100.Rda'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_cell', 'KHOS_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```




### U2OS + Xgrafts 

```{r}
ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```


### Xgrafts 

```{r}
ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('KHOS_xeno', 'MG63_xeno'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.frame(Sample = names(df)) %>%
  separate(Sample, sep = '[.]', into = c('Comp', 'Sample_Short'), remove = F) %>%
  separate(Comp, sep = '_', into = c('Cell_Line', 'Type'), remove = F) %>%
  mutate(Group = ifelse(grepl('EZHIP|C1', Sample), 'EZHIP', 'WT'))
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Comp)) +
  scale_color_manual(values = group_pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black" ) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```






### Clinical 

```{r}
group_pal = c('EZHIP_neg' = 'blue', 'EZHIP_pos' = 'red', 'H3K27me3_Low' = 'deepskyblue')
```

```{r}
clical_meta = '/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/patient_clinical_seq/out/01_raptor_exprtools/EZHIP_neg_VsEZHIP_pos_no_reps/info.samples.tsv'

ssgsea_files = list.files(path = "/lustre06/project/6004736/alvann/from_narval/220318_EZHIP/RNA/", 
           pattern = pattern, 
           full.names = T,
           recursive = T) %>%
  data.frame(group = c('hMSC_cell', 'KHOS_cell', 'MG63_cell', 'clinical', 'U2OS_cell', 'KHOS_xeno', 'MG63_xeno'))
names(ssgsea_files)[1] = c('path')
ssgsea_files = filter(ssgsea_files, group %in% c('clinical'))

l = list()
for(g in ssgsea_files$group){
  print(g)
  
  l[[g]] = data.table::fread(ssgsea_files[ssgsea_files$group == g,]$path) 
}

df = do.call(cbind, l) 
names(df)[1] = 'tmp' 
df = df %>% 
  select(!ends_with('ID')) %>%
  column_to_rownames('tmp')

meta = data.table::fread(clical_meta) %>% 
  mutate(Sample = paste0('clinical.', Nickname)) 

pal = c('EZHIP_pos' = 'red', 'EZHIP_neg' = 'blue')
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Nickname)) +
  scale_color_manual(values = pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black", size = 2) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Sex, label = Nickname)) +
  scale_color_manual(values = c('green', 'orange')) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black", size = 2) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1) + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Age, label = Nickname)) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black", size = 2) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1) + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

```{r}
meta = meta %>% filter(Nickname %in% samples)
df = df[,meta$Sample]
```

```{r}
pca = prcomp(df %>% t)

var = tibble(PC = factor(1:length(pca$sdev^2)), 
                         variance = pca$sdev) %>% 
  mutate(pct = variance/sum(variance)*100)

for(i in 1:5){
  pc.1 = paste0('PC', i)
  pc.2 = paste0('PC', i+1)
  print(pc.1)
  print(pc.2)
  
 pca_plot = pca$x %>% 
  as.data.frame() %>%
  rownames_to_column('Sample') %>%
  left_join(meta) %>% 
  ggplot(aes(x=.data[[pc.1]], y=.data[[pc.2]], color = Group, label = Nickname)) +
  scale_color_manual(values = pal) +
    geom_point(size = 4) +
  ggrepel::geom_text_repel(show.legend	= F, box.padding = 0.5, max.overlaps = Inf, color="black", size = 2) +
    theme_bw() +
    theme(text = element_text(size = 15),
        axis.line = element_line(size = 0.5),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        legend.title = element_blank(), 
        aspect.ratio = 1, 
        legend.position = 'none') + 
  xlab(paste0(pc.1, ' ', round(var[i,]$pct, digits = 1), '%')) +
  ylab(paste0(pc.2, ' ', round(var[i+1,]$pct, digits = 1), '%')) 
print(pca_plot)
}

```

```{r}

```

